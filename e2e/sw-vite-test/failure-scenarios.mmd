sequenceDiagram
    autonumber
    participant SW as Service Worker
    participant Web as Web Middleware
    participant CDN
    participant Fragment
    
    Note over SW,Fragment: SCENARIO 1: Shell fetch fails
    
    SW->>CDN: GET /remix-page.html
    CDN-->>SW: 404 Not Found
    SW->>SW: next() promise rejected?
    SW-->>SW: Error handling skips HTMLRewriter
    SW-->>Browser: Raw fragment (error path)
    
    Note over SW,Fragment: SCENARIO 2: Wrong code path
    
    SW->>Web: Request with effectiveFetchDest='document'
    Web->>Web: piercing=true, effectiveFetchDest='document'
    Web->>Web: BUG: Condition check fails?
    Web->>Web: Falls through to line 132+ (soft nav)
    Web-->>SW: Fragment only (no embedding)
    
    Note over SW,Fragment: SCENARIO 3: HTMLRewriter not invoked
    
    Web->>CDN: Fetch shell ✓
    Web->>Fragment: Fetch fragment ✓
    Web->>Web: embedFragmentIntoShellApp() called
    Web->>Web: isNativeHtmlRewriter check?
    Web->>Web: BUG: HTMLRewriter not running?
    Web-->>SW: Returns wrong response
    
    Note over SW,Fragment: SCENARIO 4: Content-type mismatch
    
    Fragment-->>Web: Response with wrong content-type
    Web->>Web: isHTMLResponse check fails
    Web->>Web: Line 102: !isHTMLResponse → early return
    Web-->>SW: Shell only (no fragment)
